name: CI Environment Cleanup

on:
  #workflow_dispatch:
  
  workflow_run:
    workflows:
      - SSH Generate & Save .config
      - Build OpenWrt
      - Build LEDE
      - Build ImmortalWrt
    types:
      - completed

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ç£ç›˜ä½¿ç”¨æƒ…å†µï¼ˆæ¸…ç†å‰ï¼‰
        run: |
          echo "=== BEFORE CLEANUP ==="
          df -h
          sudo du -h / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 30

      - name: ç§»é™¤å¤§åž‹ç³»ç»Ÿç»„ä»¶ï¼ˆå®‰å…¨ï¼‰
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true

      - name: Conditional Docker cleanup (smart detection)
        run: |
          echo "=== Docker Cleanup ==="

          # Check if docker CLI exists
          if ! command -v docker >/dev/null 2>&1; then
            echo "âŒ Docker CLI not found, skipping cleanup"
            exit 0
          fi

          # Check if Docker daemon is running
          if ! docker info >/dev/null 2>&1; then
            echo "âŒ Docker daemon not running, skipping cleanup"
            exit 0
          fi

          echo "âœ” Docker daemon detected, starting cleanup..."

          RUNNING_CONTAINERS=$(docker ps -q || true)

          if [ -n "$RUNNING_CONTAINERS" ]; then
            echo "âš ï¸ Running containers detected, performing prune only"
            sudo docker system prune -af || true
          else
            echo "âœ… No running containers, performing deep cleanup"
            sudo docker system prune -af || true
            echo "ðŸ§¹ Removing /var/lib/docker to free maximum space"
            sudo rm -rf /var/lib/docker || true
          fi

          echo "=== Docker Cleanup Done ==="
      - name: æ¸…ç† APT / æ—¥å¿— / ä¸´æ—¶æ–‡ä»¶
        run: |
          sudo apt-get clean || true
          sudo find /var/log -type f -delete || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          
      - name: æ¸…ç† /mntï¼ˆä¿ç•™ swapfileï¼‰
        run: |
          echo "Cleaning /mnt except swapfile"
          sudo find /mnt -mindepth 1 -maxdepth 1 ! -name swapfile -exec rm -rf {} +
          sudo mkdir -p /mnt
          sudo chown $USER:$USER /mnt

      - name: æ¸…ç†ç”¨æˆ·ç¼“å­˜ï¼ˆccache / npm / pipï¼‰
        run: |
          rm -rf ~/.ccache || true
          rm -rf ~/.cache/pip || true
          rm -rf ~/.npm || true

      - name: ç£ç›˜ä½¿ç”¨æƒ…å†µï¼ˆæ¸…ç†åŽï¼‰
        run: |
          echo "=== AFTER CLEANUP ==="
          df -h
          sudo du -h / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 30

      - name: Cleanup Done
        run: echo "âœ… Runner deep cleanup finished safely"
