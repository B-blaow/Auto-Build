name: Build-OpenWrt

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      WORKDIR: /mnt/openwrt
      REPO_URL: https://github.com/openwrt/openwrt
      REPO_NAME: openwrt
      SSH_ENABLE: false
      CCACHE_DIR: /mnt/ccache_openwrt
      CCACHE_MAXSIZE: 10G

    steps:
    - uses: actions/checkout@v4

    - name: Prepare
      run: |
        sudo mkdir -p $WORKDIR $CCACHE_DIR
        sudo chown -R $USER:$USER /mnt
        df -h

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
        gettext git libssl-dev python3 python3-pip python3-venv rsync unzip zlib1g-dev \
        file wget ccache

    - name: Enable ccache
      run: |
        echo 'export CC="ccache gcc"' >> ~/.bashrc
        echo 'export CXX="ccache g++"' >> ~/.bashrc
        echo 'export CCACHE_DIR=$CCACHE_DIR' >> ~/.bashrc
        source ~/.bashrc
        ccache -M $CCACHE_MAXSIZE
        ccache -s

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: /mnt/ccache_openwrt
        key: ccache-openwrt-${{ github.ref }}
        restore-keys: |
          ccache-openwrt-

    - name: Clone
      working-directory: /mnt
      run: |
        git clone $REPO_URL $REPO_NAME

    - name: SSH (optional)
      if: env.SSH_ENABLE == 'true'
      uses: mxschmitt/action-tmate@v3

    - name: Run first script
      working-directory: /mnt/openwrt
      run: |
        FILE=$(ls -1 $GITHUB_WORKSPACE/openwrt*.sh | sed -n '1p' || true)
        [ -f "$FILE" ] && chmod +x "$FILE" && "$FILE"

    - name: Put .config
      run: |
        [ -f "openwrt.config" ] && cp openwrt.config /mnt/openwrt/.config

    - name: Feeds
      working-directory: /mnt/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Run second script
      working-directory: /mnt/openwrt
      run: |
        FILE=$(ls -1 $GITHUB_WORKSPACE/openwrt*.sh | sed -n '2p' || true)
        [ -f "$FILE" ] && chmod +x "$FILE" && "$FILE"

    - name: Build
      working-directory: /mnt/openwrt
      run: |
        make defconfig
        make -j$(nproc) || make -j1 V=s
        ccache -s

    - name: Pack
      working-directory: /mnt/openwrt
      run: |
        cd bin
        zip -r ../openwrt_bin.zip .

    - name: Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt_bin
        path: /mnt/openwrt/openwrt_bin.zip

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: /mnt/openwrt/openwrt_bin.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
