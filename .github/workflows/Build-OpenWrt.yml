name: Build-OpenWrt

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      WORKDIR: /mnt/openwrt
      REPO_URL: https://github.com/openwrt/openwrt
      REPO_NAME: openwrt
      SSH_ENABLE: false

    steps:
    - uses: actions/checkout@v4

    - name: Prepare build space
      run: |
        sudo mkdir -p $WORKDIR
        sudo chown $USER:$USER $WORKDIR
        df -h

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
        gettext git libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

    - name: Clone Source
      working-directory: /mnt
      run: |
        git clone $REPO_URL $REPO_NAME
        cd $REPO_NAME
        df -h

    - name: (Optional) SSH Debug
      if: env.SSH_ENABLE == 'true'
      uses: mxschmitt/action-tmate@v3

    - name: Run first custom script
      run: |
        FILE1=$(ls -1 openwrt*.sh | sed -n '1p' || true)
        if [ -f "$FILE1" ]; then
          chmod +x "$FILE1"
          ./"$FILE1"
        fi

    - name: Put .config
      run: |
        if [ -f "openwrt.config" ]; then
          cp openwrt.config /mnt/openwrt/.config
        fi

    - name: Feeds
      working-directory: /mnt/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Run second custom script
      run: |
        FILE2=$(ls -1 openwrt*.sh | sed -n '2p' || true)
        if [ -f "$FILE2" ]; then
          chmod +x "$FILE2"
          ./"$FILE2"
        fi

    - name: Compile
      working-directory: /mnt/openwrt
      run: |
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: Package
      working-directory: /mnt/openwrt
      run: |
        cd bin
        zip -r ../openwrt_bin.zip .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt_bin
        path: /mnt/openwrt/openwrt_bin.zip

    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        files: /mnt/openwrt/openwrt_bin.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
